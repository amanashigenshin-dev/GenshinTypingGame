<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç¥ ç‰¹ç”£å“ã‚¿ã‚¤ãƒ”ãƒ³ã‚° (Genshin Typing)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #1a1a2e; /* Dark Blue Background */
            color: #e0e0e0;
            background-image: radial-gradient(#252a40 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .glass-panel {
            background: rgba(30, 35, 60, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .genshin-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .genshin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        .genshin-btn:active {
            transform: translateY(0);
        }
        .input-glow:focus {
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.5);
            border-color: #64c8ff;
            outline: none;
        }
        
        .romaji-text {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Custom Scrollbar for leaderboard */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3a4a6e; 
            border-radius: 4px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
            /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆã‚’é˜²ã */
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- App Container -->
    <div id="app" class="w-full max-w-2xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 tracking-wider drop-shadow-lg">
                <span class="text-yellow-500">åŸç¥</span> ç‰¹ç”£å“ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
            </h1>
            <p class="text-gray-400 text-sm md:text-base">å…¨ç¨®é¡ã®ç‰¹ç”£å“ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«20å•å‡ºé¡Œï¼<br>ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã§æœ€é€Ÿã‚¿ã‚¤ãƒ ã‚’ç›®æŒ‡ã›ï¼</p>
        </div>

        <!-- MENU SCREEN -->
        <div id="menuScreen" class="glass-panel rounded-2xl p-8 text-center fade-in">
            <div class="mb-6">
                <label class="block text-gray-300 mb-2 text-sm">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨)</label>
                <input type="text" id="nicknameInput" placeholder="æ—…äººã•ã‚“" class="w-full max-w-xs bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-center text-white text-lg focus:border-yellow-500 transition-colors outline-none" maxlength="10">
                <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="nicknameError" class="text-red-400 text-sm mt-2 min-h-[1.5rem]"></div>
            </div>
            
            <div class="space-y-4">
                <button onclick="startGame()" class="genshin-btn w-full max-w-xs py-4 rounded-full text-xl shadow-lg">
                    ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
                <br>
                <button onclick="showRanking()" class="text-gray-400 hover:text-white underline text-sm transition-colors">
                    ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-6">â€»ãƒ—ãƒ¬ã‚¤æ™‚ã¯IME(æ—¥æœ¬èªå…¥åŠ›)ã‚’OFFã«ã—ã¦ã€ãƒ­ãƒ¼ãƒå­—ã§ç›´æ¥ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„</p>
            <p class="text-xs text-gray-500 mt-1">â€»æŸ”è»Ÿãªå…¥åŠ›ï¼ˆä¾‹: <span class="text-yellow-400">chi/ti, sha/sya, tsu/tu</span>ï¼‰ã‚„<span class="text-yellow-400">ãƒã‚¤ãƒ•ãƒ³(-)ã«ã‚ˆã‚‹é•·éŸ³</span>ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</p>
        </div>

        <!-- GAME SCREEN -->
        <div id="gameScreen" class="hidden glass-panel rounded-2xl p-6 md:p-10 fade-in relative overflow-hidden">
            <!-- Progress & Timer -->
            <div class="flex justify-between items-center mb-8 text-gray-300 font-mono">
                <div class="text-xl">
                    å•: <span id="questionCount" class="text-yellow-400 text-2xl font-bold">1</span>/20
                </div>
                <div class="text-2xl" id="timer">00.000</div>
            </div>

            <!-- Question Display -->
            <div class="text-center mb-8">
                <!-- Reading (Hiragana) -->
                <div id="questionReading" class="text-lg md:text-xl text-gray-400 mb-1 font-bold tracking-widest min-h-[1.5rem]">
                    <!-- Hiragana goes here -->
                </div>
                <!-- Kanji Name -->
                <div id="questionKanji" class="text-3xl md:text-5xl font-bold text-white mb-3 drop-shadow-md min-h-[3.5rem]">
                    <!-- Kanji goes here -->
                </div>
                <!-- Romaji Target -->
                <div id="questionRomaji" class="text-2xl md:text-3xl text-blue-300 font-bold tracking-wider romaji-text min-h-[2rem]">
                    <!-- Romaji Target goes here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="relative max-w-md mx-auto">
                <input type="text" id="typeInput" class="w-full bg-gray-800/50 border-2 border-gray-600 rounded-xl px-6 py-4 text-center text-2xl text-white input-glow transition-all" placeholder="ãƒ­ãƒ¼ãƒå­—å…¥åŠ› (IME OFFæ¨å¥¨)" autocomplete="off" spellcheck="false" readonly>
                <div id="feedback" class="absolute right-4 top-4 text-2xl opacity-0 transition-opacity">âœ¨</div>
            </div>
            <div class="text-center text-gray-500 text-xs mt-2">
                è¡¨ç¤ºã•ã‚ŒãŸãƒ­ãƒ¼ãƒå­—ã‚’ã‚¿ã‚¤ãƒ—ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="resultScreen" class="hidden glass-panel rounded-2xl p-8 text-center fade-in">
            <h2 class="text-2xl text-yellow-500 font-bold mb-6">ä»»å‹™å®Œäº†ï¼</h2>
            
            <div class="mb-8">
                <p class="text-gray-400 text-sm">ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ </p>
                <p id="resultTime" class="text-5xl font-mono font-bold text-white my-2">00.000</p>
                <p class="text-gray-400 text-sm">ç§’</p>
            </div>

            <div class="space-y-3">
                <button onclick="resetGame()" class="genshin-btn px-8 py-3 rounded-full text-lg shadow-md w-full max-w-xs">
                    ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                </button>
                <button onclick="showRankingFromResults()" class="block w-full text-gray-400 hover:text-white text-sm mt-4">
                    ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèª
                </button>
            </div>
        </div>

        <!-- RANKING SCREEN -->
        <div id="rankingScreen" class="hidden glass-panel rounded-2xl p-6 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-yellow-500">ç‰¹ç”£å“æ—©æ‰“ã¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <button onclick="backToMenu()" class="text-sm text-gray-400 hover:text-white bg-gray-800 px-3 py-1 rounded">æˆ»ã‚‹</button>
            </div>
            
            <div class="bg-gray-900/50 rounded-lg overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-center">é †ä½</th>
                            <th class="px-4 py-3">åå‰</th>
                            <th class="px-4 py-3 text-right">ã‚¿ã‚¤ãƒ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingList" class="text-sm text-gray-200 divide-y divide-gray-700">
                        <tr><td colspan="3" class="text-center py-4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Firebase Config (EXTERNAL USE) ---
        // ğŸš¨ é‡è¦: ä»¥ä¸‹ã® YOUR_... ã®å€¤ã‚’ã€ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        // Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã€ > ã€Œã‚¢ãƒ—ãƒªã€ > ã€ŒSDK ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨æ§‹æˆã€ã‹ã‚‰Webã‚¢ãƒ—ãƒªã®è¨­å®šã‚’å–å¾—ã§ãã¾ã™ã€‚
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <--- ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", // <--- ã“ã“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        let db;
        let auth;
        let isFirebaseReady = false;
        
        // Firebaseè¨­å®šãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (firebaseConfig.apiKey && firebaseConfig.projectId && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // åŒ¿åèªè¨¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                signInAnonymously(auth).then(() => {
                    isFirebaseReady = true;
                    console.log("Firebase initialized successfully for external use.");
                }).catch(e => {
                    console.error("Firebase Auth (Anonymous) failed:", e);
                    document.getElementById('rankingList').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">Firebaseèªè¨¼å¤±æ•—: ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ç„¡åŠ¹</td></tr>';
                });
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                document.getElementById('rankingList').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">FirebaseåˆæœŸåŒ–å¤±æ•—: è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</td></tr>';
            }
        } else {
            console.warn("Firebase configuration is incomplete. Ranking feature disabled.");
        }


        // --- Profanity Filter (ä¸é©åˆ‡ãªãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°) ---
        // ç°¡æ˜“çš„ãªç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const bannedWords = [
            "ã°ã‹", "ã—ã­", "ã“ã‚ã™", "ã‚ã»", "ãã", "ã¡ã‚“", "ã¾ã‚“", "ã›ã£ãã™", 
            "fucker", "shit", "fuck", "damn", "ass", "piss", "cunt", "cock", "vagina", "penis", 
            "kill", "die", "baka", "shine", "kuso", "aho", "korosu"
        ];

        /**
         * ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒä¸é©åˆ‡ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
         * @param {string} nickname - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
         * @returns {boolean} ä¸é©åˆ‡ã§ã‚ã‚Œã° true
         */
        function isProfane(nickname) {
            const normalizedName = nickname.toLowerCase()
                                           .replace(/[^a-z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, ''); 
            
            for (const word of bannedWords) {
                if (normalizedName.includes(word.toLowerCase())) {
                    return true;
                }
            }
            return false;
        }


        // --- Data: Genshin Local Specialties (ç‰¹ç”£å“) ---
        const specialties = [
            // Mondstadt (10 items)
            { k: "ãƒ´ã‚¡ãƒ«ãƒ™ãƒªãƒ¼", r: "ãƒ´ãã‚‹ã¹ã‚Šãƒ¼", romaji: "varuberii" }, // é•·éŸ³
            { k: "ã‚»ã‚·ãƒªã‚¢ã®èŠ±", r: "ã›ã—ã‚Šã‚ã®ã¯ãª", romaji: "seshirianohana" },
            { k: "è’²å…¬è‹±ã®ç¨®", r: "ãŸã‚“ã½ã½ã®ãŸã­", romaji: "tanpoponotane" },
            { k: "æ…•é¢¨ã®ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ", r: "ã¼ãµã†ã®ã¾ã£ã—ã‚…ã‚‹ãƒ¼ã‚€", romaji: "bofuunomasshuruumu" }, // é•·éŸ³, ä¿ƒéŸ³
            { k: "ã‚°ã‚°ãƒ—ãƒ©ãƒ ", r: "ããã·ã‚‰ã‚€", romaji: "gugupuramu" },
            { k: "é¢¨è»Šã‚¢ã‚¹ã‚¿ãƒ¼", r: "ãµã†ã—ã‚ƒã‚ã™ãŸãƒ¼", romaji: "fuushaaasutaa" }, // é•·éŸ³
            { k: "ãƒ‰ãƒ‰ãƒªã‚¢ãƒ³", r: "ã©ã©ã‚Šã‚ã‚“", romaji: "dodorian" },
            { k: "ã‚¤ã‚°ã‚µ", r: "ã„ãã•", romaji: "igusa" },
            { k: "ãƒ•ãƒ­ã‚¹ãƒˆãƒ©ãƒ³ãƒ—", r: "ãµã‚ã™ã¨ã‚‰ã‚“ã·", romaji: "furosutoranpu" },
            { k: "æœˆè½éŠ€", r: "ã’ã¤ã‚‰ããã‚“", romaji: "getsurakugin" },
            
            // Liyue (11 items)
            { k: "çµ¶é›²ã®å”è¾›å­", r: "ãœã¤ã†ã‚“ã®ã¨ã†ãŒã‚‰ã—", romaji: "zetsuunnotougarashi" },
            { k: "æ¸…å¿ƒ", r: "ã›ã„ã—ã‚“", romaji: "seishin" },
            { k: "ç‰ç’ƒè¢‹", r: "ã‚‹ã‚Šã¶ãã‚", romaji: "ruribukuro" },
            { k: "éœ“è£³èŠ±", r: "ã’ã„ã—ã‚‡ã†ã°ãª", romaji: "geishoubana" },
            { k: "ç‰ç’ƒç™¾åˆ", r: "ã‚‹ã‚Šã‚†ã‚Š", romaji: "ruriyuri" },
            { k: "çŸ³ç€", r: "ã›ãã¯ã", romaji: "sekihaku" },
            { k: "å¤œæ³ŠçŸ³", r: "ã‚ˆã©ã¾ã‚Šã„ã—", romaji: "yodomariishi" },
            { k: "æ˜Ÿèº", r: "ã›ã„ã‚‰", romaji: "seira" },
            { k: "è¡€çŸ³è¯", r: "ã‘ã£ã“ãã°ãª", romaji: "kekkokubana" }, // ä¿ƒéŸ³
            { k: "å²©è£‚ã®èŠ±", r: "ãŒã‚“ã‚Œã¤ã®ã¯ãª", romaji: "ganretsunohana" }, 
            { k: "ç‰é±—çŸ³", r: "ã‚Šã‚…ã†ã‚Šã‚“ã›ã", romaji: "ryuurinseki" }, 
            
            // Inazuma (10 items)
            { k: "ã‚¦ãƒŸãƒ¬ã‚¤ã‚·", r: "ã†ã¿ã‚Œã„ã—", romaji: "umireishi" },
            { k: "ã‚ªãƒ‹ã‚«ãƒ–ãƒˆãƒ ã‚·", r: "ãŠã«ã‹ã¶ã¨ã‚€ã—", romaji: "onikabutomushi" },
            { k: "é³´è‰", r: "ãªãã•", romaji: "nagusa" },
            { k: "ç·‹æ«»æ¯¬", r: "ã²ãŠã†ãã‚…ã†", romaji: "hioukyuu" }, // æ‹—éŸ³
            { k: "æ™¶åŒ–éª¨é«„", r: "ã—ã‚‡ã†ã‹ã“ã¤ãšã„", romaji: "shoukakotsuzui" },
            { k: "çŠç‘šçœŸç ", r: "ã•ã‚“ã”ã—ã‚“ã˜ã‚…", romaji: "sangoshinju" }, // æ‹—éŸ³
            { k: "å¤©é›²è‰ã®å®Ÿ", r: "ã‚ã¾ãã‚‚ãã•ã®ã¿", romaji: "amakumokusanomi" },
            { k: "ãƒ¦ã‚¦ãƒˆã‚¦ã‚¿ã‚±", r: "ã‚†ã†ã¨ã†ãŸã‘", romaji: "yuutoutake" },
            { k: "æ¯ã‚Œç´«è–", r: "ã‹ã‚Œã—ã—ã‚‡ã†", romaji: "kareshishou" },
            { k: "è›å…‰ãƒ„ãƒã‚­ãƒã‚³", r: "ã‘ã„ã“ã†ã¤ã®ãã®ã“", romaji: "keikoutsunokinoko" }, 

            // Sumeru (11 items)
            { k: "ã‚µã‚¦ãƒãƒ©ã‚¿è“®", r: "ã•ã†ã¾ã‚‰ãŸã¯ã™", romaji: "saumaratahasu" },
            { k: "ã‚«ãƒ«ãƒ‘ãƒ©ã‚¿è“®", r: "ã‹ã‚‹ã±ã‚‰ãŸã¯ã™", romaji: "karuparatahasu" },
            { k: "ãƒ«ãƒƒã‚«ãƒ‡ãƒ´ã‚¡ãƒ¼ã‚¿ãƒ€ã‚±", r: "ã‚‹ã£ã‹ã§ãƒ´ããƒ¼ãŸã ã‘", romaji: "rukkadevaatadake" }, // ä¿ƒéŸ³, é•·éŸ³
            { k: "ãƒ‘ãƒ†ã‚£ã‚µãƒ©", r: "ã±ã¦ãƒã•ã‚‰", romaji: "patisara" },
            { k: "è–é‡‘è™«", r: "ã›ã„ãã‚“ã¡ã‚…ã†", romaji: "seikinchuu" }, // æ‹—éŸ³
            { k: "èµ¤å¿µã®å®Ÿ", r: "ã›ãã­ã‚“ã®ã¿", romaji: "sekinennomi" },
            { k: "ç ‚è„‚è›¹", r: "ã•ã—ã‚ˆã†", romaji: "sashiyou" },
            { k: "ã‚µãƒ³ã‚°ã‚¤ãƒˆ", r: "ã•ã‚“ãã„ã¨", romaji: "sanguito" },
            { k: "æ‚¼éœŠèŠ±", r: "ã¨ã†ã‚Œã„ã‹", romaji: "toureika" },
            { k: "ã‚µã‚¦ãƒªã‚¢ãƒ³ã‚µã‚­ãƒ¥ãƒ¬ãƒ³ãƒˆ", r: "ã•ã†ã‚Šã‚ã‚“ã•ãã‚…ã‚Œã‚“ã¨", romaji: "sauriansakyurento" },
            { k: "ã‚·ãƒ£ã‚¯ã‚®ã‚¯", r: "ã—ã‚ƒããã", romaji: "shakugiku" },
            
            // Fontaine (12 items)
            { k: "è’¼æ™¶èº", r: "ãã†ã—ã‚‡ã†ã‚‰", romaji: "soushoura" },
            { k: "ãƒ­ãƒãƒªã‚¿ã‚¤ãƒ ãƒ•ãƒ©ãƒ¯ãƒ¼", r: "ã‚ã¾ã‚ŠãŸã„ã‚€ãµã‚‰ã‚ãƒ¼", romaji: "romaritaimufurawaa" }, // é•·éŸ³
            { k: "ãƒ«ãƒŸãƒ‰ã‚¥ãƒ¼ã‚¹ãƒ™ãƒ«", r: "ã‚‹ã¿ã©ã…ãƒ¼ã™ã¹ã‚‹", romaji: "rumiduusuberu" }, // é•·éŸ³
            { k: "ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ­ãƒ¼ã‚º", r: "ã‚Œã„ã‚“ã¼ãƒ¼ã‚ãƒ¼ãš", romaji: "reinbooroozu" }, // é•·éŸ³
            { k: "ãƒ«ã‚¨ãƒˆãƒ¯ãƒ¼ãƒ«", r: "ã‚‹ãˆã¨ã‚ãƒ¼ã‚‹", romaji: "ruetowaaru" }, // é•·éŸ³
            { k: "æ¢æ¸¬ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»å­æ©Ÿ", r: "ãŸã‚“ããã‚†ã«ã£ã¨ã“ã", romaji: "tansokuyunittokoki" }, // ä¿ƒéŸ³
            { k: "æ¹–å…‰ã®éˆ´è˜­", r: "ã“ã“ã†ã®ã™ãšã‚‰ã‚“", romaji: "kokounosuzuran" },
            { k: "åˆéœ²ã®æº", r: "ã¯ã¤ã¤ã‚†ã®ã¿ãªã‚‚ã¨", romaji: "hatsutsuyunominamoto" }, // ä¿ƒéŸ³
            { k: "æ¸…æ°´ç‰", r: "ã›ã„ã™ã„ãã‚‡ã", romaji: "seisuigyoku" }, // æ‹—éŸ³
            { k: "æ³¢ã—ã¶ãã®ã‚¨ãƒ©", r: "ãªã¿ã—ã¶ãã®ãˆã‚‰", romaji: "namishibukinoera" },
            { k: "ã‚±ãƒãƒ‘ãƒ™ãƒªãƒ¼", r: "ã‘ã­ã±ã¹ã‚Šãƒ¼", romaji: "kenepaberii" }, // é•·éŸ³
            { k: "æºè¡Œå‹ãƒ™ã‚¢ãƒªãƒ³ã‚°", r: "ã‘ã„ã“ã†ãŒãŸã¹ã‚ã‚Šã‚“ã", romaji: "keikougatabearingu" },
        ];
        
        // --- Game State ---
        let currentQuestions = [];
        let currentIndex = 0;
        let startTime = 0;
        let timerInterval = null;
        let userNickname = "";
        let romajiIndex = 0; // Romajiå…¥åŠ›ã®é€²æ—ã‚’è¿½è·¡ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        // --- DOM Elements ---
        const screens = {
            menu: document.getElementById('menuScreen'),
            game: document.getElementById('gameScreen'),
            result: document.getElementById('resultScreen'),
            ranking: document.getElementById('rankingScreen')
        };
        const input = document.getElementById('typeInput');
        const display = {
            kanji: document.getElementById('questionKanji'),
            reading: document.getElementById('questionReading'),
            romaji: document.getElementById('questionRomaji'),
            count: document.getElementById('questionCount'),
            timer: document.getElementById('timer'),
            resultTime: document.getElementById('resultTime')
        };

        // --- Functions Exposed to Window ---
        window.startGame = function() {
            const nickInput = document.getElementById('nicknameInput');
            const errorDisplay = document.getElementById('nicknameError');
            const nick = nickInput.value.trim();

            errorDisplay.textContent = ''; // Clear previous error

            if (!nick) {
                errorDisplay.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                nickInput.focus();
                return;
            }

            if (isProfane(nick)) {
                errorDisplay.textContent = 'ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚';
                nickInput.focus();
                return;
            }

            userNickname = nick;

            const shuffled = [...specialties].sort(() => 0.5 - Math.random());
            currentQuestions = shuffled.slice(0, 20); // è³ªå•æ•°ã¯20å•ã®ã¾ã¾ç¶­æŒ
            
            currentIndex = 0;
            romajiIndex = 0; 
            switchScreen('game');
            
            input.value = '';
            input.focus();
            updateDisplay();
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 10);
        };

        window.resetGame = function() {
            switchScreen('menu');
        };

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function updateTimer() {
            const now = Date.now();
            const diff = (now - startTime) / 1000;
            display.timer.textContent = diff.toFixed(3);
        }

        function updateDisplay() {
            if (currentIndex >= currentQuestions.length) {
                finishGame();
                return;
            }
            const q = currentQuestions[currentIndex];
            const targetRomaji = q.romaji;

            display.kanji.textContent = q.k;
            display.reading.textContent = q.r;
            
            const typed = targetRomaji.substring(0, romajiIndex);
            const remaining = targetRomaji.substring(romajiIndex);

            // æ­£ã—ãå…¥åŠ›ã•ã‚ŒãŸéƒ¨åˆ†ã‚’ç·‘è‰²ã§è¡¨ç¤º
            display.romaji.innerHTML = `<span class="text-green-400">${typed}</span><span>${remaining}</span>`;
            display.count.textContent = currentIndex + 1;
        }

        function flashFeedback() {
            const fb = document.getElementById('feedback');
            fb.style.opacity = '1';
            setTimeout(() => fb.style.opacity = '0', 300);
        }

        function finishGame() {
            clearInterval(timerInterval);
            const finalTime = parseFloat(display.timer.textContent);
            display.resultTime.textContent = finalTime.toFixed(3);
            switchScreen('result');
            saveScore(finalTime);
        }

        /**
         * æŸ”è»Ÿãªãƒ­ãƒ¼ãƒå­—å…¥åŠ›ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ã‚¿ã‚¤ãƒ—ã•ã‚ŒãŸã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã€
         * æœ‰åŠ¹ãªå ´åˆã«æ­£è¦ã®Romajiã‚’ä½•æ–‡å­—ã‚¹ã‚­ãƒƒãƒ— (æ¶ˆè²») ã™ã‚‹ã‹ã‚’è¿”ã™ã€‚
         * @param {string} typedKey - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸã‚­ãƒ¼ (å°æ–‡å­—)ã€‚
         * @param {string} targetRomaji - æ­£è¦ã®ãƒ­ãƒ¼ãƒå­— (ä¾‹: 'seshirianohana')ã€‚
         * @param {number} romajiIndex - ç¾åœ¨ã®æ­£è¦ã®Romajiå†…ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚
         * @returns {number} é€²ã‚ã‚‹ã¹ãæ–‡å­—æ•° (0: ä¸æ­£è§£/ä¸ä¸€è‡´, 1ä»¥ä¸Š: æ­£è§£ã¨ã¿ãªã™æ–‡å­—æ•°)ã€‚
         */
        function getAdvanceCount(typedKey, targetRomaji, romajiIndex) {
            const typedLower = typedKey.toLowerCase();
            const currentCanonicalChar = targetRomaji[romajiIndex];
            
            // 1. å³å¯†ãªä¸€è‡´
            if (typedLower === currentCanonicalChar) {
                return 1;
            }

            // 2. æŸ”è»Ÿãªä¸€è‡´ãƒ­ã‚¸ãƒƒã‚¯
            const remaining = targetRomaji.substring(romajiIndex);
            const prevChar = romajiIndex > 0 ? targetRomaji[romajiIndex - 1] : '';

            // --- D: ä¼¸ã°ã—æ£’ (-) å¯¾å¿œ ---
            const isVowel = 'aiueo'.includes(currentCanonicalChar);
            if (typedLower === '-' && isVowel && prevChar === currentCanonicalChar) {
                return 1;
            }

            // --- A: 'h' ã‚„ 's' ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æŸ”è»Ÿå…¥åŠ› (si, ti, tu) ---
            if (prevChar === 'c' && remaining.startsWith('hi') && typedLower === 'i') { return 2; }
            if (prevChar === 's' && remaining.startsWith('hi') && typedLower === 'i') { return 2; }
            if (prevChar === 't' && remaining.startsWith('su') && typedLower === 'u') { return 2; }

            // --- B: å­éŸ³ã‚’èª­ã¿æ›¿ãˆã‚‹æŸ”è»Ÿå…¥åŠ› (fu/hu, ji/zi, zu/du ãªã©) ---
            if (currentCanonicalChar === 'f' && typedLower === 'h' && remaining.startsWith('fu')) { return 1; }
            if (currentCanonicalChar === 'j' && typedLower === 'z' && remaining.length >= 2) {
                 const nextChar = remaining[1];
                 if ('aiueoy'.includes(nextChar)) { return 1; }
            }
            if (currentCanonicalChar === 'z' && typedLower === 'd' && remaining.startsWith('zu')) { return 1; }

            // --- C: æ‹—éŸ³ã®æŸ”è»Ÿå…¥åŠ› ('h' ã‚’ã‚¹ã‚­ãƒƒãƒ—ã— 'y' ã‚’å—ã‘å…¥ã‚Œã‚‹) ---
            if (currentCanonicalChar === 'h' && typedLower === 'y' && remaining.length >= 2) {
                const nextChar = remaining[1]; 
                if (prevChar === 'c' && 'auo'.includes(nextChar)) { return 1; }
                if (prevChar === 's' && 'auo'.includes(nextChar)) { return 1; }
            }
            
            return 0;
        }

        // --- Input Logic (Romaji Typing) ---
        input.addEventListener('keydown', (e) => {
            if (currentIndex >= currentQuestions.length) return;
            const currentQ = currentQuestions[currentIndex];
            const targetRomaji = currentQ.romaji;

            if (e.isComposing || e.keyCode === 229) return;
            if (e.metaKey || e.ctrlKey || e.altKey) return;
            
            if (e.key === 'Backspace') {
                e.preventDefault(); 
                if (romajiIndex > 0) {
                    romajiIndex--;
                    input.value = targetRomaji.substring(0, romajiIndex); 
                    updateDisplay();
                }
                return;
            }

            if (e.key.length === 1 && romajiIndex < targetRomaji.length) {
                e.preventDefault(); 
                
                const typedKey = e.key.toLowerCase();
                const advanceCount = getAdvanceCount(typedKey, targetRomaji, romajiIndex);

                if (advanceCount > 0) {
                    // æ­£è§£ã®å ´åˆã€å…¥åŠ›å€¤ã¯ç›´è¿‘ã®ã‚«ãƒŠã«ä¸€è‡´ã™ã‚‹æ­£è¦ã®ãƒ­ãƒ¼ãƒå­—ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šã®ãŸã‚ï¼‰
                    // ä¾‹: 'shi'ã‚’'si'ã¨æ‰“ã£ãŸå ´åˆã€input.valueã«ã¯'s'ã®å¾Œã«'h'ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸçŠ¶æ…‹ã§'i'ãŒã‚¿ã‚¤ãƒ—ã•ã‚ŒãŸã¨è¦‹ã›ã‚‹ã®ãŒè¤‡é›‘ãªãŸã‚ã€
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚¤ãƒ—ã—ãŸæ–‡å­—ã‚’ãã®ã¾ã¾åæ˜ ã—ã¾ã™ã€‚
                    if (typedKey !== '-') { // ãƒã‚¤ãƒ•ãƒ³ã¯å…¥åŠ›ã¨ã—ã¦æ¶ˆè²»ã™ã‚‹ãŒè¡¨ç¤ºã—ãªã„
                        input.value += typedKey; 
                    }

                    romajiIndex += advanceCount; 
                    updateDisplay();
                    
                    if (romajiIndex >= targetRomaji.length) {
                        flashFeedback();
                        romajiIndex = 0; 
                        currentIndex++;
                        input.value = ''; 
                        updateDisplay();
                    }
                } else {
                    input.classList.add('border-red-500');
                    setTimeout(() => input.classList.remove('border-red-500'), 150);
                }
            }
        });


        // --- Leaderboard Logic ---
        async function saveScore(time) {
            if (!isFirebaseReady) {
                console.warn("Firebase not ready. Score not saved.");
                return;
            }
            try {
                // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« 'scores' ã«å¤‰æ›´
                await addDoc(collection(db, `scores`), { 
                    nickname: userNickname,
                    time: time,
                    createdAt: serverTimestamp()
                });
                console.log("Score saved successfully!");
            } catch (e) {
                console.error("Error saving score:", e);
            }
        }

        window.showRanking = function() {
            switchScreen('ranking');
            loadRanking();
        };

        window.showRankingFromResults = function() {
            window.showRanking();
        };

        window.backToMenu = function() {
            switchScreen('menu');
        };

        async function loadRanking() {
            const tbody = document.getElementById('rankingList');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

            if (!isFirebaseReady) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">Firebaseè¨­å®šãŒå¿…è¦ã§ã™ã€‚</td></tr>';
                return;
            }

            try {
                // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« 'scores' ã«å¤‰æ›´
                const q = query(
                    collection(db, `scores`),
                    orderBy("time", "asc"),
                    limit(10)
                );
                const querySnapshot = await getDocs(q);
                
                tbody.innerHTML = '';
                let rank = 1;
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = data.nickname === userNickname && Math.abs(data.time - parseFloat(display.resultTime.textContent || 0)) < 0.01;
                    const rowClass = isMe ? "bg-yellow-900/30 text-yellow-200" : "";
                    
                    const row = `
                        <tr class="${rowClass} hover:bg-white/5 transition-colors">
                            <td class="px-4 py-3 text-center font-mono ${rank <= 3 ? 'text-yellow-400 font-bold' : 'text-gray-500'}">#${rank}</td>
                            <td class="px-4 py-3 font-medium truncate max-w-[120px]">${escapeHtml(data.nickname)}</td>
                            <td class="px-4 py-3 text-right font-mono">${data.time.toFixed(3)}s</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                    rank++;
                });

            } catch (e) {
                console.error("Error loading ranking:", e);
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</td></tr>';
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
